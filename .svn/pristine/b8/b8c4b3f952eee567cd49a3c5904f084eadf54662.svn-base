/**
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      		ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 7. 5.     	ê¹€ì¬ìœ¤				ìµœì´ˆ ì‘ì„±
 * 2025. 7. 8.      ê¹€ì¬ìœ¤               ì±„íŒ…ë°© ê°œì„¤ ê³¼ì • êµ¬í˜„
 * 
 * </pre>
 */

let showingPublic = false; // ê¸°ë³¸ê°’: ì°¸ì—¬ ì±„íŒ…ë°©

document.addEventListener("DOMContentLoaded", () => {
  const createBtn = document.querySelector("#createChatBtn");
  const toggleBtn = document.querySelector("#togglePublicBtn");
  const buildingSelect = document.querySelector("#buildingSelect");

  // 1. ì±„íŒ…ë°© ê°œì„¤ ë²„íŠ¼
  createBtn?.addEventListener("click", () => {
    window.location.href = "/resident/chat/createRoom?popup=true";;
  });

  // ê³µê°œ / ì°¸ì—¬ ì±„íŒ… í† ê¸€
  toggleBtn?.addEventListener("click", () => {
    showingPublic = !showingPublic;
    updateToggleButton();
    loadChatRooms();
  });

  // ì±„íŒ… ë°© ëª©ë¡ ê°±ì‹ 
  buildingSelect?.addEventListener("change", loadChatRooms);

  // ì´ˆê¸°í™”
  updateToggleButton();
  loadBuildingOptions(); // ì…ì£¼ ì¤‘ì¸ ê±´ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
});

// í† ê¸€ ë²„íŠ¼
function updateToggleButton() {
  const toggleBtn = document.querySelector("#togglePublicBtn");
  toggleBtn.innerText = showingPublic
    ? "ğŸ‘¥ ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°© ë³´ê¸°"
    : "ğŸŒ ê³µê°œ ì±„íŒ…ë°© ë³´ê¸°";
}

// ì…ì£¼ ì¤‘ì¸ ê±´ë¬¼ ëª©ë¡
function loadBuildingOptions() {
  fetch("/resident/chat/residentBuilding")
    .then(res => {
      if (!res.ok) throw new Error("ê±´ë¬¼ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨");
      return res.json();
    })
    .then(buildings => {
      const buildingSelect = document.querySelector("#buildingSelect");
      buildingSelect.innerHTML = "";

      buildings.forEach(bldg => {
        const option = document.createElement("option");
        option.value = bldg.bldgId;          // âœ… ì„œë²„ì— ë„˜ê¸¸ ID
        option.textContent = bldg.bldgNm; // âœ… ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ì´ë¦„
        buildingSelect.appendChild(option);
      });

      if (buildings.length > 0) {
        loadChatRooms();
      } else {
        renderEmptyMessage("ì…ì£¼ ì¤‘ì¸ ê±´ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
      }
    })
    .catch(err => {
      console.error("ê±´ë¬¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
      renderEmptyMessage("ê±´ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    });
}

// ì±„íŒ…ë°© ëª©ë¡ ë¡œë”©
function loadChatRooms() {
  const buildingSelect = document.querySelector("#buildingSelect");
  const chatRoomList = document.querySelector("#chatRoomList");
  const bldgId = buildingSelect?.value || "";

  if (!bldgId) {
    renderEmptyMessage("ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  fetch(`/resident/chat/list?bldgId=${bldgId}`) // âœ… ì •í™•í•œ ID ì „ë‹¬
    .then(res => {
      if (!res.ok) throw new Error("ì±„íŒ…ë°© ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨");
      return res.json();
    })
    .then(renderChatRoomList)
    .catch(err => {
      console.error("ì±„íŒ…ë°© ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
      renderEmptyMessage("ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    });
}

// ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
function renderChatRoomList(chatRooms) {
  const chatRoomList = document.querySelector("#chatRoomList");
  chatRoomList.innerHTML = "";

  if (chatRooms.length === 0) {
    renderEmptyMessage("ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br />ìƒˆë¡œìš´ ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”.");
    return;
  }

  chatRooms.forEach(room => {
    chatRoomList.appendChild(createChatRoomItem(room));
  });
}

// ğŸ”§ ì±„íŒ…ë°© í•­ëª© DOM ìƒì„±
function createChatRoomItem(room) {
  const item = document.createElement("div");
  item.className = "chat-room-item";
  item.dataset.roomId = room. residentChatRoomId;

  item.innerHTML = `
    <div class="chat-room-name">${room.residentChatRoomTitle}</div>
    <div class="chat-room-last-message">
      ${room.lastMessage || "ìµœê·¼ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤."}
    </div>
  `;
  item.addEventListener("dblclick", () => {
  const roomId = item.dataset.roomId;
  const popupUrl = `/resident/chat/room?residentChatRoomId=${roomId}&popup=true`;
  window.open(popupUrl, "chatRoomPopup", "width=600,height=700,scrollbars=yes");
});
  return item;
}

// ê³µí†µ ë¹ˆ ë©”ì‹œì§€ ë Œë”ë§
function renderEmptyMessage(message) {
  const chatRoomList = document.querySelector("#chatRoomList");
  chatRoomList.innerHTML = `
    <div class="chat-empty-message">${message}</div>
  `;  
}
