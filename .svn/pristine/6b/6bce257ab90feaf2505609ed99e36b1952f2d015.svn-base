<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì…ì£¼ë¯¼ ê²€ìƒ‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select { margin-right: 10px; padding: 5px; }
    button { padding: 6px 12px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <h2>ğŸ¢ ì…ì£¼ë¯¼ ê²€ìƒ‰</h2>

  <div>
    <select id="searchType">
      <option value="unitRoom">í˜¸ì‹¤</option>
      <option value="mbrNnm">ë‹‰ë„¤ì„</option>
    </select>
    <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
    <button type="button" onclick="searchResidents()">ê²€ìƒ‰</button>
  </div>

  <form id="residentForm">
    <table>
      <thead>
        <tr>
          <th>í˜¸ì‹¤</th>
          <th>ë‹‰ë„¤ì„</th>
          <th>ì„ íƒ</th>
        </tr>
      </thead>
      <tbody id="residentTableBody">
        <tr><td colspan="3">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
      </tbody>
    </table>

    <div style="margin-top: 20px;">
      <button type="button" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button>
      <button type="button" onclick="window.close()">ë‹«ê¸°</button>
    </div>
  </form>

  <script>
    window.addEventListener("load", () => {
      let bldgId = null;

      const urlParams = new URLSearchParams(window.location.search);
      bldgId = urlParams.get("bldgId");
      console.log("ğŸ“¦ bldgId:", bldgId);

      if (!bldgId) {
        alert("ê±´ë¬¼ IDê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }

      fetchResidents(bldgId);

      function fetchResidents(urlOrBldgId) {
        const url = urlOrBldgId.startsWith("/resident/")
          ? urlOrBldgId
          : "/resident/chat/getResidentList?bldgId=" + urlOrBldgId;

        console.log("ğŸ“¡ ìš”ì²­ URL:", url);

        fetch(url)
          .then(res => {
            if (!res.ok) throw new Error("ì…ì£¼ë¯¼ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨");
            return res.json();
          })
          .then(data => {
            console.log("ğŸ“¥ ë°›ì€ ë°ì´í„°:", data);
            renderResidents(data);
          })
          .catch(err => {
            console.error("âŒ ì…ì£¼ë¯¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
            alert("ì…ì£¼ë¯¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      function searchResidents() {
        const searchType = document.querySelector("#searchType").value;
        const keyword = document.querySelector("#searchKeyword").value.trim();

        if (!keyword) {
          fetchResidents(bldgId);
          return;
        }

        fetch("/resident/chat/getResidentList?bldgId=" + bldgId)
          .then(res => res.json())
          .then(data => {
            const filtered = data.filter(r => {
              const unitRoom = r.unit?.unitRoom ?? "";
              const mbrNnm = r.member?.mbrNnm ?? "";

              if (searchType === "unitRoom") {
                return unitRoom === keyword;
              } else if (searchType === "mbrNnm") {
                return mbrNnm.includes(keyword);
              }
              return false;
            });

            renderResidents(filtered);
          })
          .catch(err => {
            console.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨:", err);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      function renderResidents(data) {
        const tbody = document.querySelector("#residentTableBody");
        tbody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = "<tr><td colspan='3'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
          return;
        }

        data
          .slice()
          .sort((a, b) => {
            const roomA = parseInt(a.unit?.unitRoom ?? "0", 10);
            const roomB = parseInt(b.unit?.unitRoom ?? "0", 10);
            return roomA - roomB;
          })
          .forEach((r, i) => {
            const mbrCd = r.mbrCd ?? "";
            const mbrNnm = r.member?.mbrNnm != null ? String(r.member.mbrNnm) : "(ë‹‰ë„¤ì„ ì—†ìŒ)";
            const unitRoom = r.unit?.unitRoom != null ? String(r.unit.unitRoom) : "(í˜¸ì‹¤ ì—†ìŒ)";

            const row = document.createElement("tr");

            const tdRoom = document.createElement("td");
            tdRoom.textContent = unitRoom;

            const tdName = document.createElement("td");
            tdName.textContent = mbrNnm;

            const tdCheck = document.createElement("td");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = mbrCd;
            checkbox.dataset.name = mbrNnm;
            checkbox.dataset.unitRoom = unitRoom; // âœ… ì¶”ê°€ë¨
            tdCheck.appendChild(checkbox);

            row.appendChild(tdRoom);
            row.appendChild(tdName);
            row.appendChild(tdCheck);

            tbody.appendChild(row);
          });
      }

      function confirmSelection() {
        const checked = Array.from(document.querySelectorAll("input[type='checkbox']:checked"));
        const members = checked.map(chk => ({
          mbrCd: chk.value,
          name: chk.dataset.name,
          unitRoom: chk.dataset.unitRoom // âœ… ì¶”ê°€ë¨
        }));

        if (window.opener && typeof window.opener.receiveSelectedMembers === "function") {
          window.opener.receiveSelectedMembers(members);
        }
        window.close();
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
      window.searchResidents = searchResidents;
      window.confirmSelection = confirmSelection;
    });
  </script>
</body>
</html>